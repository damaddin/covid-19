
<!doctype html>

<html lang="en">

  <head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    
  </head>

  <body>
    <canvas id="chart"></canvas>

    <div id="decrease"></div> average growth rate decrease over last days (aka are measures effective)

  </body>

  <script src="util.js"></script>

  <script>

      const recoveryTime = 14;
      const growthRateSample = 4;
      

    chart.options.scales.yAxes[0].scaleLabel.labelString = 'Growth factor';

    start(generateData(), generatePrediction(), generateDataActive());

    function generateData() {
        return data => {
            
            let count = 0;
            var result = data.map(e => {
                count ++;
                return e.confirmed;
            });

           /* for (var i = 0; i < count; i++) {
                result.push(0);
            }*/
            return result;
        };
    }

    function generateDataActive() {
        return data => {
            var growthRate = calcGrowthRate(data);
            var decrease = calcGrowthDecrease(growthRate);
            
            let count = 0;
            var result = data.map(e => {
                count ++;
                return e.confirmed;
            });

            prev = result[count-1];
            let currentRate = growthRate[count-1];
            for (var i = 0; i < count; i++) {
                var point = prev * currentRate; 
                result.push(point);
                prev = point;
                currentRate -= decrease;
                // no new cases are reported.
                if (currentRate < 1) currentRate = 1;
            }

            // active cases: after confirmation, x days of sickness.
            var newCases = [];
            newCases[0] = 0;

            var healthy = 0;
            for (var i = 1; i < result.length; i++) {
                healthy += result[i] - result[i-1];
                newCases[i] = healthy;
            }

            for (var i = recoveryTime; i < result.length; i++) {
                result[i] = result[i] - newCases[i - recoveryTime];
            }


            return result;
        };
    }

    


    function generatePrediction() {
        return data => {
            var growthRate = calcGrowthRate(data);
            var decrease = calcGrowthDecrease(growthRate);
            
            let count = 0;
            var result = data.map(e => {
                count ++;
                return e.confirmed;
            });

            prev = result[count-1];
            let currentRate = growthRate[count-1];
            for (var i = 0; i < count; i++) {
                var point = prev * currentRate; 
                result.push(point);
                prev = point;
                currentRate -= decrease;
                // no new cases are reported.
                if (currentRate < 1) currentRate = 1;
            }
            return result;
        };
    }



    function calcGrowthRate(data) {
        let prev;
        var growthRate = data.map(e => {
            const r = e.confirmed / prev;
            prev = e.confirmed;
            return r;
        });
        return growthRate
    }

    function calcGrowthDecrease(growthRate) {
        // get the decrease in growth factor over the last x days;
        let decrease = 0;
        for (var i = growthRate.length - growthRateSample; i < growthRate.length; i++) {
            decrease += growthRate[i-1] - growthRate[i];
        }
        decrease = 0.006; //decrease / growthRateSample;

        document.getElementById("decrease").textContent = decrease;
        return decrease;
    }
  </script>

</html>